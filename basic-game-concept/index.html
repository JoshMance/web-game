
<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="styles.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>   
    $(document).ready(function() {
        
        var SIZE            = 8;             // The grid size
        var SIZE_SQUARED    = 64;
        var NUM_SETUP_ROWS  = 2;
        var $focused_tile   = null;          // A reference to the most recent
                                            // tile selected by the user 
        var focused_moves   = null;          // A list of the 
        var no_piece_class  = 'empty-space'; // 
    
        var $game_tiles     = Array(SIZE)    // A 2d array holding references to
                            .fill()          // each game tile jquery object
                            .map(() => Array(SIZE).fill(null));
        

        // Removes "highlight" from the class name of all tiles
        function clear_highlights() {
            for (let row = 0; row < SIZE; row++) {
                for (let col = 0; col < SIZE; col++) {
                    $game_tiles[row][col].css("box-shadow", "none")
                }
            }
        }

        // Adds "highlight" to the class name of the tile/s
        function highlight_moves(moves) {
            for (move of moves) {
                $game_tiles[move[0]][move[1]].css("box-shadow", "inset 0 0 11px 11px #F6F3F1")
            }
        }

        // Setting up the game-container with tiles and tokens
        function setup_game_board() {
            for (let row = 0; row < SIZE; row++) {
                for (let col = 0; col < SIZE; col++) {
                    $('.tiles-grid').append($('<div>', {row: row, 
                                                        col: col, 
                                                        class: 'tile'}))
                    let piece_class = no_piece_class;
                    if (row < NUM_SETUP_ROWS) {piece_class = 'piece opponent'}
                    else if (row >= (SIZE - NUM_SETUP_ROWS)) {piece_class = 'piece user'}
                
                    var $piece = $('.tiles-grid').children().last()
                                    .append($('<div>', {class: piece_class,
                                                        draggable: true}
                                              )) 
                                        
                    $game_tiles[row][col] = $($piece);
                }
            }
        }

        // Returns the indexes of all valid moves from the given location
        function get_all_valid_moves(row, col) {

            var valid_moves  = new Set();
            var translations = new Array([1, 0], [-1,0], [0,-1], [0, 1])
            for (trans of translations) { 
                let r = row;
                let c = col;

                do {
                    valid_moves.add([r, c]);
                    r += trans[0];
                    c += trans[1]; 
                    if (r >= SIZE || c >= SIZE || r < 0 || c < 0) {
                        break;
                    }
                }
                while ($($game_tiles[r][c]).children()[0].className === no_piece_class);

            }
            return Array.from(valid_moves);
        }

        // Iterates through the game_tiles array, changing the class of any 
        // piece with two 'enemy' pieces either (1) directly above and below 
        // or (2) directly to the left and right
        function remove_trapped_pieces() {
            var trapped_locations = new Set();

            for (let row = 1; row < SIZE-1; row++) {
                for (let col = 1; col < SIZE-1; col++) {

                    let left   = $game_tiles[row][col-1].children()[0].className.toString();
                    let centre = $game_tiles[row][col].children()[0].className.toString();
                    let right  = $game_tiles[row][col+1].children()[0].className.toString();
                    let above  = $game_tiles[row-1][col].children()[0].className.toString();
                    let below  = $game_tiles[row+1][col].children()[0].className.toString();


                    let row_line = (left === right) && 
                                    (left !== centre) && 
                                    (left !== no_piece_class) &&
                                    (centre !== no_piece_class);
                    
                    let col_line = (below === above) && 
                                    (below !== centre) && 
                                    (below !== no_piece_class) &&
                                    (centre !== no_piece_class);

                        if (row_line || col_line) {
                            trapped_locations.add(Array(row, col));
                        }                                
                }
            }

            setTimeout(() => {            
                if (trapped_locations.size > 0) {
                    for (loc of Array.from(trapped_locations)) {
                        var row = loc[0];
                        var col = loc[1];

                        $game_tiles[row][col].empty();
                        $game_tiles[row][col].append($('<div>', {class: 'empty-space'}))
                    }
                }
            }, "500");
        }

        // Moves a piece by changing the class of the target piece div 
        // to "no_piece_class" and setting the destination piece div 
        // class as either "piece user" or "piece opponent" 
        function move_piece($start_tile, $dest_tile) {
            let movement_sound = new Audio("./piece_moving.wav");
            movement_sound.play();

            var $temp_piece = $start_tile.children().clone(false)

            var $start_children = $start_tile.children().detach();
            var $dest_children  = $dest_tile.children().detach();

            $('.tiles-grid').append($temp_piece);
            
            $($temp_piece).css({
                        "left":$start_tile[0].offsetLeft + 20, 
                        "top":$start_tile[0].offsetTop + 20
                        });

            $($temp_piece).css("position", "absolute").animate({
                left: $dest_tile[0].offsetLeft + 20,
                top:  $dest_tile[0].offsetTop + 20,
            });

            $start_tile.append($dest_children);
            $dest_tile.append($start_children);
            $dest_tile.children().css({'visibility': 'hidden'});

            setTimeout(() => {
                $('.tiles-grid').children().last().remove();
                $dest_tile.children().css({'visibility': 'visible'});
            }, "400");
        }


        function tile_click_handler () {
            var is_empty_space = this.children[0].className === no_piece_class;
            let row = parseInt(this.attributes.row.value);
            let col = parseInt(this.attributes.col.value);

            if ($focused_tile === null) {
                if (!is_empty_space) {
                    $focused_tile = $(this);
                    focused_moves = get_all_valid_moves(row, col);
                    highlight_moves(focused_moves);
                }
            }
            else {
                clear_highlights();
                if (!is_empty_space) {
                    focused_moves = get_all_valid_moves(row, col);
                    $focused_tile = $(this);
                    highlight_moves(focused_moves);
                    
                }
                else {
                    for (move of focused_moves) {
                        if (row === move[0] && col === move[1]) {
                            move_piece($focused_tile, $(this));
                            remove_trapped_pieces();
                            $focused_tile = null;
                            break;
                        }
                    }
                    if ($focused_tile != null) {
                        highlight_moves(focused_moves);
                    }
                }
            }            
        };


        setup_game_board();
        $('.tile').on('click', tile_click_handler);
      
    });
</script>
</head>
<body>
    <div class="game-container">
        <h1>Opponent</h1>
        <div class="tiles-grid"></div>
        <h1>User</h1>
    </div>
    
    
</body>
</html> 

