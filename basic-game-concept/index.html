
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        
        var SIZE                 = 8;
        var SIZE_SQUARED         = SIZE*SIZE;
        var focused_tile_index  = null;
        var focused_tile_moves  = null;
        var overlay_class = 'empty-space';

        function setup_game_board() {
            // The game visual is a grid of tile divs. Tokens are children of these divs 
            // Token movement involves:
            //     1. Animating a 'movement' token over the target token
            //     2. Appending the target token to its new tile and making it invisible
            //     3. Animating the movement token sliding to the new tile, then deleting it
            //     4. Showing the target token

            // Setting up the game-container with tiles and tokens
            for (let index = 0; index < SIZE_SQUARED; index++) {
                $('.tiles-grid').append($('<div>', {id: index, class: 'tile'}))
                var overlay_class = 'empty-space'
                if (index < 16)  {overlay_class = 'token user'}
                if (index >= 48) {overlay_class = 'token opponent'}
                $('.tiles-grid').children().last().append($('<div>', {class: overlay_class}))
            }
        }

        function remove_trapped_tokens() {
            var trapped_indexes_set = new Set();
            var $tiles = $('.tiles-grid').children();

            for (let i = 0; i < SIZE_SQUARED; i++) {
                if (i > SIZE && i < (SIZE_SQUARED - SIZE)) {
                    if (i % SIZE >= 1 && i % SIZE < SIZE-1) {

                        var left  = $tiles[i-1].children[0].className.toString();
                        var mid   = $tiles[i].children[0].className.toString();
                        var right = $tiles[i+1].children[0].className.toString();
                        var bot   = $tiles[i-SIZE].children[0].className.toString();
                        var top   = $tiles[i+SIZE].children[0].className.toString();

                        var row_line = (left === right) && 
                                       (left !== mid) && 
                                       (left !== 'empty-space') &&
                                       (mid !== 'empty-space');
                        
                        var col_line = (bot === top) && 
                                       (bot !== mid) && 
                                       (bot !== 'empty-space') &&
                                       (mid !== 'empty-space');

                        if (row_line || col_line) {
                            trapped_indexes_set.add(i);
                        }                        
                        

                    }
                }
            }
            for (index of Array.from(trapped_indexes_set)) {
                if (index === focused_tile_index) {
                    focused_tile_index = null;
                    focused_tile_moves  = null;
                }
                $('.tiles-grid').children()[index].replaceChildren();
                $('.tiles-grid').get(index).append($('<div>', {class: 'empty-space'}))


            }


        }

        function move_token(start_index, dest_index) {

            let sound_sfx = new Audio("./move_sfx.wav");
            sound_sfx.play();

            var $start_tile = $('.tiles-grid > #' + start_index);
            var $dest_tile  = $('.tiles-grid > #' + dest_index);

            var $start_overlay = $start_tile.children().detach();
            var $dest_overlay  = $dest_tile.children().detach();

            $start_tile.append($dest_overlay);
            $dest_tile.append($start_overlay);
        }


        function remove_all_highlights() {
            let tiles = Array.from($('.tiles-grid').children());
            for (i in tiles) {
                let tile = tiles[i];
                if (tile.classList.contains('highlight')) {
                    tile.classList.remove('highlight');
                }
            }
        }

        function highlight_moves(tile_index, move_indexes) {
            let tiles = $('.tiles-grid').children();
            tiles[tile_index].classList.add('highlight');
            for (i in move_indexes) {
                var index = move_indexes[i];
                tiles[index].classList.add('highlight');
            }
        }


        // Returns the indexes of all valid moves from the given tile
        function get_valid_move_indexes(tile_index) {

            var tiles          = $('.tiles-grid').children();
            var valid_indexes  = new Set();
            var col_moves      = new Array(SIZE, -SIZE); 
            var row_moves      = new Array(-1, 1); 
    
            for (i in col_moves) {
                let move = parseInt(col_moves[i]);
                var index = tile_index + move;

                while (index >= 0 && index < SIZE_SQUARED) {
                    if (tiles[index].children[0].classList.contains('empty-space')) {
                        valid_indexes.add(index);
                    }
                    else {
                        break;
                    }
                    index += move;
                }
            }

            for (i in row_moves) {
                let move = parseInt(row_moves[i]);
                var index = tile_index + move;

                var lower_bound = index - (index % SIZE);
                var upper_bound = lower_bound + SIZE;
                while (index >= lower_bound && index < upper_bound) {
                    if (tiles[index].children[0].classList.contains('empty-space')) {
                        valid_indexes.add(index);
                    }
                    else {
                        break;
                    }
                    index += move;
                }
            }
            return Array.from(valid_indexes);
        }


        $(document).ready(function() {
            setup_game_board();

            $('.tile').on('click', function() {
                var target_tile_index = parseInt(this.id);
                let tile = $('.tiles-grid').children()[target_tile_index];
                var is_empty_space = tile.children[0].classList.contains('empty-space');

                if (focused_tile_index == null) {
                    if (!is_empty_space) {
                        focused_tile_index = target_tile_index;
                        // focused_tile_moves = get_valid_move_indexes(focused_tile_index);
                        // highlight_moves(focused_tile_index, focused_tile_moves);
                    }
                }
                else {
                    remove_all_highlights();
                    focused_tile_moves = get_valid_move_indexes(focused_tile_index);
                    if (!is_empty_space) {
                        focused_tile_index = target_tile_index;
                        // highlight_moves(target_tile_index, focused_tile_moves);
                    }
                    else {
                        if (focused_tile_moves.includes(target_tile_index)) {
                            move_token(focused_tile_index, target_tile_index);
                            remove_trapped_tokens();
                            focused_tile_index = null;
                        }
                    }
                }

                
            });
        });

    </script>
</head>
<body>
    <div class="game-container">
        <h1>Opponent</h1>
        <div class="tiles-grid"></div>
        <h1>User</h1>
    </div>
    
    
</body>
</html> 

